# 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

- 현재 사용 중인 IP는 2가지 버전이 있다.
    - IPv4, IPv6

## 4.3.1 IPv4 데이터그램 포맷

- 인터넷 네트워크 계층 패킷: 데이터그램(datagram)
    - IP 정보는 각 패킷에 첨부되며, 이 정보는 라우터가 패킷을 올바른 곳으로 보내는 것에 도움이 된다.
- IPv4 데이터그램의 주요 필드
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/42d22f3a-8061-4e0f-86bd-e002a4bb02d7/Untitled.png)
    
    - **버전 번호**: 4bits, **IP 프로토콜 버전을 명시**함. 라우터는 버전 번호를 확인해 **데이터그램의 나머지 부분을 어떻게 해석할지 결정**한다.
    - **헤더 길이**: IPv4 데이터그램은 이 4bits로 IP 데이터그램에서 실제 페이로드(데이터그램에 캡슐화된 트랜스포트 계층 세그먼트)가 시작하는 곳을 결정한다.
    - **서비스 타입**: 각기 다른 유형의 IP 데이터그램을 구별한다. 예를 들어 실시간 데이터그램(ex) IP 전화 통신 애플리케이션)과 비실시간 트래픽(ex) FTP)을 구분하는 데 유용하다. **이 필드를 통해 해당 패킷이 얼마나 중요하고 긴급한 것인지 알 수 있다.**
    - **데이터그램 길이**: 바이트로 계산한 IP 데이터그램(헤더와 데이터)의 전체 길이이다.
    - **식별자, 플래그, 단편화 오프셋** : IP 단편화와 관련 있음. 
    큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음 목적지로 독립적으로 전달
    → 페이로드 데이터가 최종 호스트의 트랜스포트 계층으로 전달되기 전에 다시 모인다.
    **IPv6는 단편화를 허용하지 않음!!**
    - **TTL(time-to-live)**: 패킷이 목적지를 찾지 못했을 때 네트워크를 무한히 순환하는 것을 방지
    - **프로토콜**: IP 데이터그램에서 데이터 부분이 전달될 목적지의 트랜스포트 계층의 특정 프로토콜을 명시. 즉, 상위 계층 프로토콜을 알려준다.
    - **헤더 체크섬**: IP 데이터그램의 비트 오류를 탐지하는 데 도움을 준다.(헤더의 오류를 검출)
                            **라우터는 보통 오류가 검출된 데이터그램을 폐기한다.**
    - **출발지와 목적지 IP 주소**: 데이터그램을 보낸 송신지 주소, 데이터그램을 받을 수신지 주소를 필드에 삽입
    - **옵션**: 이 필드는 IP 헤더를 확장한다. 오버헤드를 해결하기 위해 헤더 옵션은 거의 사용되지 않는다.
    - **데이터(페이로드)**: 트랜스포트 계층 세그먼트(TCP나 UDP)를 포함하지만 ICMP(5.6장) 메시지 같은 유형의 데이터를 담기도 한다.

## 4.3.3 IPv4 주소체계

- 호스트는 일반적으로 네트워크와 연결되는 하나의 링크를 가진다.
- 호스트 IP가 데이터그램을 보낼 때 이 링크를 통해 데이터링크를 보낸다.
- 라우터의 작업은 한 링크로부터 데이터그램을 수신하여 다른 링크로 전달하는 것. 따라서 라우터는 2개 이상의 연결된 링크가 필요하다.
- 인터페이스
    - 호스트와 물리적 링크 사이의 경계
    - 라우터와 링크 사이의 경계
- 각 링크마다 하나의 인터페이스를 갖고 하나의 라우터는 여러 개의 인터페이스를 갖는다.
- **모든 호스트와 라우터는 IP 데이터그램을 송수신 할 수 있으므로 각 호스트와 라우터 인터페이스가 IP 주소를 갖도록 요구함.**
- 기술면에서 IP 주소는 인터페이스를 포함하는 호스트 라우터보다는 인터페이스와 관련이 있다.
- **모든 호스트와 라우터의 각 인터페이스는 고유한 IP 주소를 가진다. 또한 이는 마음대로 선택 불가**

### 서브넷(subnet)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/ff834ca6-d970-478f-ac7e-7a77928fed91/Untitled.png)

- 맨 왼쪽 3개의 호스트와 연결된 라우터 인터페이스는 [223.1.1.xxx](http://223.1.1.xxx) 형식의 IP 주소를 가짐.
- 이 4개는 인터페이스가 중계하는 라우터 없이 하나의 네트워크에 연결
- 이 네트워크는 이더넷 LAN으로 상호연결됨
- **이를 서브넷(subnet)을 구성한다고 말한다.**
- IP 주소체계는 이 서브넷에 223.1.1.0/24 라는 주소를 할당하는데, 여기서 /24는 서브넷 마스크라 부름. 32비트의 왼쪽 24가 서브넷 주소라는 것을 가리킨다.

### CIDR

- 인터넷 주소 할당 방식
- 서브넷 주소체계

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/2d18c6ab-f534-4031-9029-39b3937387f7/75234816-57b3-4c42-953b-9deb4d9be03e.png)

- 각 네트워크 대역을 구분 짓고, Intra-Domain 과 같이 구분된 네트워크 간 통신을 위한 주소 체계

[[네트워크] CIDR이란?(사이더 란?)](https://kim-dragon.tistory.com/9)

- a.b.c.d/x 형태
- x는 IP 주소의 네트워크 부분을 구성한다. 이를 해당 주소의 프리픽스(prefix)라고 부름
- 한 기관은 통상 연속적인(공통 프리픽스를 갖는 주소 범위) 주소의 블록을 할당받는다.
- 이 경우 기관 장비들의 IP 주소는 공통 프리픽스를 공유한다.
- 주소의 나머지 32-x bits는 기관 내부에 같은 네트워크 프리픽스를 갖는 모든 장비를 구별
- ex) a.b.c.d/21
    - 첫 21 bits: 기관의 네트워크 프리픽스
    - 나머지 11bits: 기관 내부의 특정 호스트들을 식별
    - 기관의 내부 구조가 이 최하위 11bits 중 일부를 기관 내부의 서브넷을 위해 사용할 수도 있음

## 주소 블록 획득

- 기관의 서브넷에서 사용하기 위한 IP 주소 블록을 얻기 위해, 네트워크 관리자는 먼저 이미 할당받은 주소의 큰 블록에서 주소를 제공하는 ISP와 접촉해야 한다.
- 이때 **ISP도 주소 블록을 얻기 위한 방법**이 있어야 하는데, 이러한 일을 하는 **최상위 국제 기관이 ICANN**이다.

## 호스트 주소 획득: 동적 호스트 구성 프로토콜

### 동적 호스트 구성 프로토콜(DHCP)

- ISP에서 운영
- DHCP는 호스트가 IP 주소를 자동으로 얻을 수 있게 한다.
- 네트워크 관리자는 해당 호스트가 네트워크에 접속하고자 할 때마다 동일한 IP 주소를 받도록 하거나, 다른 임시 IP 주소를 할당하도록 DHCP를 설정한다.

[네트워크 기초 - DHCP](https://daengsik.tistory.com/m/16)

### **DHCP Server**

- 클라이언트로부터 IP 할당 요청이 들어오면 IP를 부여하고, 할당 가능한 IP들을 관리한다.

### **DHCP Client**

- DHCP 서버에 자신의 시스템을 위한 IP 주소를 요청한다.
- 일반적으로 네트워크 설정을 위한 정보를 얻고자 새롭게 도착한 호스트

### DHCP 동작 과정

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/40e57e0b-118d-4d96-9ff9-536ff0beeb7c/Untitled.png)

**1. DHCP Discover**

- 클라이언트는 MAC 주소를 기반으로 네트워크에 DHCP 서버를 찾는 Discover 패킷을 브로드캐스팅
- 클라이언트 → 네트워크 전체

**2. DHCP Offer**

- DHCP 서버가 Discover 패킷을 받게되면 서버는 할당할 IP 주소 정보를 포함한 정보를 포함한 Offer 패킷을 브로드캐스팅합니다.
- 서버 → 클라이언트

**3. DHCP Request**

- 클라이언트는 Offer를 받았으면 DHCP 서버의 존재유무를 깨닫고, Requst 패킷을 통해 하나의 DHCP 서버를 선택하며 제공자에게 사용할 네트워크 정보를 요청

**4. DHCP Ack**

- DHCP Request에 대해 요청된 파라미터를 확인하는 DHCP ACK로 응답

## 4.3.3 네트워크 주소 변환(NAT)

[[Network-04] Network Address Translation(NAT)](https://velog.io/@richpin/Network-Network-Address-TranslationNAT)

- SOHO(small office, home office) 네트워크의 확산 → ISP는 모든 SOHO의 IP 장치를 수용할 수 있는 큰 주소 범위를 할당해야 함. but, 주소가 부족하다면?
- 네트워크 주소 변환(NAT)
- 사설 주소를 Routing이 가능한 외부 공인 IP 주소로 변환해주는 것이 NAT
- 사설 주소를 갖는 권역이란 네트워크 주소들이 그 네트워크의 내부에 있는 장비에게만 의미가 있는 그런 네트워크를 의미함.

### NAT 동작 과정

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/aa8cecb7-f861-4c2e-9008-21e84cebf7d7/Untitled.png)

**1.** PC1은 SRC IP에 자신의 사설 주소, DST IP에 Web Server의 IP주소를 적어 packet을 전송합니다.

**2.** 패킷은 모뎀과 라우터 R1(Private Address를 가진 Router)를 타고(forwarding) Border Router인 R2에 도달하게 됩니다.

**3. NAT 기능을 가진 R2는 SRC IP의 192.168.10.10을 Public IP인 209.165.200.226으로 Mapping** 합니다(바꿔줍니다).

**4.** 그 패킷은 여러 Router를 타고 Web Server에 도달합니다. 그 후, 서버는 SRC와 DST를 바꿔 클라이언트(PC1)으로 packet을 전송합니다.(DST는 Public인 209.165.200.226가 되겠죠?)

**5.** **R2는 도달한 패킷을 보고 NAT table을 보고 아까 Mapping 하였던 entry를 확인해 다시 사설 주소로 바꿔줍니다.**

**6.** packet은 다시 타고 타서 PC1에 도착하게 됩니다.

# 4.3.4 IPv6

- 32비트를 사용하는 IPv4의 IP 주소의 고갈이 찾아옴 → 새로운 IP 체제로 나온 것이 바로 **IPv6.**
- IPv6에서는 기존 IPv4의 32비트에서 4배나 많은 128비트의 주소로 아주 많은 주소를 포함할 수 있다.
- 흐름 레이블링: IPv6는 정의하기 어려운 흐름(flow)을 갖고 있다. 예를 들어, 오디오/비디오 전송은 흐름으로 처리, 파일 전송이나 전자메일 같은 예전의 애플리케이션은 흐름으로 처리되지 않음.
**흐름의 정확한 의미는 아직 정의되지 않음. 하지만 언젠가 필요할 흐름 차별화를 예견함.**

### IPv6 데이터그램 포맷

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/87b62ef0-0ad2-4fe3-b88c-61a43750dd1c/15e15c5b-4471-44d4-9951-fea9714a9626.png)

- **버전**: 4bits, IP 버전 번호를 인식. IPv6에서 이 필드 값은 ‘6’이다.(but, 단순히 이 필드를 ‘4’로 준다고 해서 IPv6가 되는 것은 아님)
- **트래픽 클래스**: 특정 애플리케이션 데이터그램에 우선순위를 부여하는 데 사용
- **흐름 레이블**: 앞서 말한 데이터그램의 흐름을 인식하는 데 사용
- **페이로드 길이**: IPv6 데이터그램에서 고정 길이 40byte 패킷 헤더 뒤에 나오는 바이트 길이
- **다음 헤더**: 데이터그램의 내용이 전달될 프로토콜(ex) UDP, TCP)을 구분
- **홉 제한**: 이 필드 값은 라우터가 데이터그램을 전달할 때마다 1씩 감소. 홉 제한 수가 0보다 작아지만 라우터는 데이터그램을 버림.
- **출발지와 목적지 주소**
- **데이터**

### IPv4에는 있지만 IPv6에는 없는 것

- **단편화/재결합**: 라우터가 받은 IPv6 데이터그램이 너무 커서 출력 링크로 전달할 수 없다면 라우터는 데이터그램을 폐기 → ‘패킷이 너무 크다’는 ICMP 오류 메시지를 송신자에게 보냄.
→ 송신자는 데이터를 IP 데이터그램 크기를 줄여서 다시 보냄
**단편화와 재결합은 시간이 걸리므로 라우터에서 이 기능을 삭제하고 종단 시스템이 하게 하면 네트워크에서 IP 전달 속도가 증가한다.**
- **헤더 체크섬**: 트랜스포트 계층 프로토콜과 데이터 링크 프로토콜은 체크섬을 수행하므로 IPv6에서는 생략
- **옵션**

## IPv4에서 IPv6로의 전환

- IPv4 데이터그램을 보내고 라우팅하며 받을 수 있는 새 IPv6 시스템이 있는 반면, 이미 IPv4로 구축된 시스템은 IPv6 데이터그램을 처리할 수 없다.

**방법 1**

- 플래그 데이 선언
    - 모든 인터넷 장비를 끄고 IPv4에서 IPv6로 업그레이드 하는 시간과 날짜를 정하는 것
    - 사실상 불가능

**방법 2**

- 터널링
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/bcae6a3a-d3f8-457f-b546-084947de2c55/9a9eab23-2f69-41c4-97f6-28f143045033/Untitled.png)
    
    - **B, E**: IPv6 데이터그램을 사용해서 작동. 이들은 IPv4 라우터를 통해 연결됨.
    - **터널**: 두 IPv6 사이에 있는 IPv4 라우터들
    - B는 IPv6 데이터그램을 받음 
    → IPv4 데이터그램의 데이터(페이로드)필드에 이것을 넣음 
    → 이 IPv4 데이터그램에 목적지 주소를 E로 적어 C로 전송
    → **터널 내부에 있는 IPv4 라우터는 IPv4 데이터그램이 IPv6 데이터그램을 갖고 있다는 사실을 모른 채 이 IPv4 데이터그램을 처리**
    → 터널 수신측에 있는 IPv6 노드(E)는 IPv4 데이터그램을 받고 이 데이터그램이 실제로는 IPv6라는 것을 판단(**IPv4 데이터그램 프로토콜 번호 필드가 41이면 알 수 있다고 함**)
